<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>日语歌词注音解析器</title>
    <script src="./kuromoji.js-master/build/kuromoji.js"></script>
    <style>
        /* 样式优化 */
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Meiryo, sans-serif;
            line-height: 1.6;
        }

        .lyric-block {
            margin: 30px 0;
            border-left: 3px solid #eee;
            padding-left: 15px;
        }

        .time {
            color: #999;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .japanese-line {
            font-size: 1.4em;
            line-height: 2;
            font-family: 'MS PGothic', 'Yu Gothic', Meiryo, sans-serif;
        }

        .japanese-line rt {
            font-size: 0.55em;
            color: #d32f2f;
            font-family: 'Hiragino Sans', Meiryo, sans-serif;
        }

        .romaji-line {
            color: #1976d2;
            font-size: 0.95em;
            letter-spacing: 0.8px;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
            opacity: 0.9;
        }

        .translation-line {
            color: #388e3c;
            font-size: 0.9em;
            border-top: 1px dotted #ddd;
            padding-top: 8px;
        }
    </style>
</head>
<body>
    <div id="lyrics-container"></div>

<script>
// 片假名转平假名函数
const kataToHira = (str) => {
    return str.replace(/[\u30A1-\u30FA]/g, match => {
        return String.fromCharCode(match.charCodeAt(0) - 0x60);
    }).replace(/゠/gu, "ー");
};

// 扩展罗马音映射表
const romajiMap = {
    'あ':'a', 'い':'i', 'う':'u', 'え':'e', 'お':'o',
    'か':'ka', 'き':'ki', 'く':'ku', 'け':'ke', 'こ':'ko',
    'さ':'sa', 'し':'shi', 'す':'su', 'せ':'se', 'そ':'so',
    'た':'ta', 'ち':'chi', 'つ':'tsu', 'て':'te', 'と':'to',
    'な':'na', 'に':'ni', 'ぬ':'nu', 'ね':'ne', 'の':'no',
    'は':'ha', 'ひ':'hi', 'ふ':'fu', 'へ':'he', 'ほ':'ho',
    'ま':'ma', 'み':'mi', 'む':'mu', 'め':'me', 'も':'mo',
    'や':'ya', 'ゆ':'yu', 'よ':'yo',
    'ら':'ra', 'り':'ri', 'る':'ru', 'れ':'re', 'ろ':'ro',
    'わ':'wa', 'を':'wo', 'ん':'n',
    'が':'ga', 'ぎ':'gi', 'ぐ':'gu', 'げ':'ge', 'ご':'go',
    'ざ':'za', 'じ':'ji', 'ず':'zu', 'ぜ':'ze', 'ぞ':'zo',
    'だ':'da', 'ぢ':'ji', 'づ':'zu', 'で':'de', 'ど':'do',
    'ば':'ba', 'び':'bi', 'ぶ':'bu', 'べ':'be', 'ぼ':'bo',
    'ぱ':'pa', 'ぴ':'pi', 'ぷ':'pu', 'ぺ':'pe', 'ぽ':'po',
    'きゃ':'kya', 'きゅ':'kyu', 'きょ':'kyo',
    'しゃ':'sha', 'しゅ':'shu', 'しょ':'sho',
    'ちゃ':'cha', 'ちゅ':'chu', 'ちょ':'cho',
    'にゃ':'nya', 'にゅ':'nyu', 'にょ':'nyo',
    'ひゃ':'hya', 'ひゅ':'hyu', 'ひょ':'hyo',
    'みゃ':'mya', 'みゅ':'myu', 'みょ':'myo',
    'りゃ':'rya', 'りゅ':'ryu', 'りょ':'ryo',
    'ぎゃ':'gya', 'ぎゅ':'gyu', 'ぎょ':'gyo',
    'じゃ':'ja', 'じゅ':'ju', 'じょ':'jo',
    'びゃ':'bya', 'びゅ':'byu', 'びょ':'byo',
    'ぴゃ':'pya', 'ぴゅ':'pyu', 'ぴょ':'pyo',
    'ふぁ':'fa', 'ふぃ':'fi', 'ふぇ':'fe', 'ふぉ':'fo',
    'ゔぁ':'va', 'ゔぃ':'vi', 'ゔぇ':'ve', 'ゔぉ':'vo',
    'ー': '', 'っ':''
};

// 高级罗马音转换函数
const hiraToRomaji = (hira) => {
    let romaji = '';
    let i = 0;
    const len = hira.length;
    
    while(i < len) {
        const current = hira[i];
        const next = hira[i+1] || '';
        const combined = current + next;

        // 处理拗音
        if(romajiMap[combined]) {
            romaji += romajiMap[combined];
            i += 2;
            continue;
        }

        // 处理促音
        if(current === 'っ') {
            const nextChar = hira[i+1];
            if(nextChar && romajiMap[nextChar]) {
                romaji += romajiMap[nextChar][0];
            }
            i++;
            continue;
        }

        // 常规处理
        romaji += romajiMap[current] || current;
        i++;
    }

    // 长音处理
    return romaji.replace(/([aeiou])(?=\1)/g, '');
};

// 初始化Kuromoji
kuromoji.builder({ dicPath: './kuromoji.js-master/dict/' }).build((err, tokenizer) => {
    if(err) { throw err; }

    // 示例歌词数据
    const lyricsData = [
        {
            time: "[00:01.200]",
            japanese: "君と夏の終わり 将来の夢",
            translation: "与你共度的夏末 未来的梦想"
        },
        {
            time: "[00:05.400]",
            japanese: "大きな希望 忘れない",
            translation: "满怀的希望 不会忘记"
        },
        {
            time: "[00:09.600]",
            japanese: "10年後の8月 また出会えるのを 信じて",
            translation: "相信十年后的八月 我们还能再相遇"
        }
    ];

    // 处理歌词
    lyricsData.forEach(data => {
        try {
            const tokens = tokenizer.tokenize(data.japanese);
            
            // 生成注音HTML
            const rubyHtml = tokens.map(token => {
                const surface = token.surface_form;
                const reading = token.reading ? kataToHira(token.reading) : surface;
                
                if(/[\u4E00-\u9FAF]/.test(surface)) {
                    return `<ruby>${surface}<rt>${reading}</rt></ruby>`;
                }
                return surface;
            }).join('');

            // 生成罗马音
            const romajiLine = tokens.map(token => {
                const reading = token.reading ? kataToHira(token.reading) : token.surface_form;
                return hiraToRomaji(reading);
            }).join(' ');

            // 创建DOM元素
            const block = document.createElement('div');
            block.className = 'lyric-block';
            block.innerHTML = `
                <div class="time">${data.time}</div>
                <div class="japanese-line">${rubyHtml}</div>
                <div class="romaji-line">${romajiLine}</div>
                <div class="translation-line">${data.translation}</div>
            `;
            document.getElementById('lyrics-container').appendChild(block);

        } catch (e) {
            console.error(`处理失败: ${data.japanese}`, e);
        }
    });
});
</script>
</body>
</html>
